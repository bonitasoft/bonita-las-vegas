<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

	<!-- Load system properties in Spring context -->
	<bean id="systemPropResolver" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
	</bean>

	<!-- We need 2 datasources that target the same DB : -->
	<!-- First datasource (bonitaDataSource) for the whole Bonita platform -->
	<!-- Second datasource (bonitaSequenceManagerDataSource) for the SequenceManager implementation in order not to be stuck when we need some new ids -->

	<!-- TODO : factorize the driverClass, jdbcUrl, user, password -->

	<bean id="bonitaDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">

<!-- 		<property name="driverClass" value="com.mysql.jdbc.Driver" /> -->
<!-- 		<property name="jdbcUrl" value="jdbc:mysql://localhost:3306/bonita?useUnicode=true&amp;characterEncoding=UTF-8" /> -->
<!-- 		<property name="user" value="root" /> -->
<!-- 		<property name="password" value="" /> -->

		<property name="driverClass" value="org.h2.Driver" />
		<property name="jdbcUrl" value="jdbc:h2:tcp://localhost/${bonita.home}/server/platform/work/bonita6_journal;FILE_LOCK=NO;LOCK_MODE=0;MVCC=TRUE;DB_CLOSE_ON_EXIT=TRUE;IGNORECASE=TRUE" />
		<property name="user" value="sa" />
		<property name="password" value="" />

		<!--property name="acquireIncrement" value="toBeDefined" / --><!-- default:3 -->
		<!--property name="acquireRetryAttempts" value="toBeDefined" / --><!-- default:30 -->
		<property name="acquireRetryDelay" value="50" /><!-- default:1000 -->
		<!--property name="autoCommitOnClose" value="toBeDefined" / --><!-- default:false -->
		<!--property name="automaticTestTable" value="toBeDefined" / --><!-- default:null -->
		<!--property name="breakAfterAcquireFailure" value="toBeDefined" / --><!-- default:false -->
		<!--property name="checkoutTimeout" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="connectionCustomizerClassName" value="toBeDefined" / --><!-- default:null -->
		<!--property name="connectionTesterClassName" value="toBeDefined" / --><!-- com.mchange.v2.c3p0.impl.DefaultConnectionTester -->
		<!--property name="dataSourceName" value="toBeDefined" / --><!-- default:if configured with a named config, the config name, otherwise the pool's "identity token" -->
		<!--property name="debugUnreturnedConnectionStackTraces" value="toBeDefined" / --><!-- default:false -->
		<!--property name="forceIgnoreUnresolvedTransactions" value="toBeDefined" / --><!-- default:false -->
		<property name="idleConnectionTestPeriod" value="300" /><!-- default:0 -->
		<!--property name="initialPoolSize" value="toBeDefined" / --><!-- default:3 -->
		<!--property name="maxAdministrativeTaskTime" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxConnectionAge" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxIdleTime" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxIdleTimeExcessConnections" value="toBeDefined" / --><!-- default:0 -->
		<property name="maxPoolSize" value="50" /><!-- default:15 -->
		<!--property name="maxStatements" value="toBeDefined" / --><!-- default:0 -->
		<property name="maxStatementsPerConnection" value="500" /><!-- default:0 -->
		<property name="minPoolSize" value="3" /><!-- default:3 -->
		<property name="numHelperThreads" value="20" /><!-- default:3 -->
		<!--property name="overrideDefaultPassword" value="toBeDefined" / --><!-- default:null -->
		<!--property name="overrideDefaultUser" value="toBeDefined" / --><!-- default:null -->
		<!--property name="preferredTestQuery" value="toBeDefined" / --><!-- default:null -->
		<!--property name="propertyCycle" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="statementCacheNumDeferredCloseThreads" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="testConnectionOnCheckin" value="toBeDefined" / --><!-- default:false -->
		<!--property name="testConnectionOnCheckout" value="toBeDefined" / --><!-- default:false -->
		<!--property name="unreturnedConnectionTimeout" value="toBeDefined" / --><!-- default:0 -->
	</bean>	

	<!-- Create the datasource -->
	<bean id="bonitaSequenceManagerDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">

<!-- 		<property name="driverClass" value="com.mysql.jdbc.Driver" /> -->
<!-- 		<property name="jdbcUrl" value="jdbc:mysql://localhost:3306/bonita?useUnicode=true&amp;characterEncoding=UTF-8" /> -->
<!-- 		<property name="user" value="root" /> -->
<!-- 		<property name="password" value="" /> -->
		
		
		<property name="driverClass" value="org.h2.Driver" />
		<property name="jdbcUrl" value="jdbc:h2:tcp://localhost/${bonita.home}/server/platform/work/bonita6_journal;FILE_LOCK=NO;LOCK_MODE=0;MVCC=TRUE;DB_CLOSE_ON_EXIT=TRUE;IGNORECASE=TRUE" />
		<property name="user" value="sa" />
		<property name="password" value="" />

		<!--property name="acquireIncrement" value="toBeDefined" / --><!-- default:3 -->
		<!--property name="acquireRetryAttempts" value="toBeDefined" / --><!-- default:30 -->
		<property name="acquireRetryDelay" value="50" /><!-- default:1000 -->
		<!--property name="autoCommitOnClose" value="toBeDefined" / --><!-- default:false -->
		<!--property name="automaticTestTable" value="toBeDefined" / --><!-- default:null -->
		<!--property name="breakAfterAcquireFailure" value="toBeDefined" / --><!-- default:false -->
		<!--property name="checkoutTimeout" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="connectionCustomizerClassName" value="toBeDefined" / --><!-- default:null -->
		<!--property name="connectionTesterClassName" value="toBeDefined" / --><!-- com.mchange.v2.c3p0.impl.DefaultConnectionTester -->
		<!--property name="dataSourceName" value="toBeDefined" / --><!-- default:if configured with a named config, the config name, otherwise the pool's "identity token" -->
		<!--property name="debugUnreturnedConnectionStackTraces" value="toBeDefined" / --><!-- default:false -->
		<!--property name="forceIgnoreUnresolvedTransactions" value="toBeDefined" / --><!-- default:false -->
		<property name="idleConnectionTestPeriod" value="300" /><!-- default:0 -->
		<!--property name="initialPoolSize" value="toBeDefined" / --><!-- default:3 -->
		<!--property name="maxAdministrativeTaskTime" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxConnectionAge" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxIdleTime" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="maxIdleTimeExcessConnections" value="toBeDefined" / --><!-- default:0 -->
		<property name="maxPoolSize" value="3" /><!-- default:15 -->
		<!--property name="maxStatements" value="toBeDefined" / --><!-- default:0 -->
		<property name="maxStatementsPerConnection" value="500" /><!-- default:0 -->
		<property name="minPoolSize" value="1" /><!-- default:3 -->
		<property name="numHelperThreads" value="3" /><!-- default:3 -->
		<!--property name="overrideDefaultPassword" value="toBeDefined" / --><!-- default:null -->
		<!--property name="overrideDefaultUser" value="toBeDefined" / --><!-- default:null -->
		<!--property name="preferredTestQuery" value="toBeDefined" / --><!-- default:null -->
		<!--property name="propertyCycle" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="statementCacheNumDeferredCloseThreads" value="toBeDefined" / --><!-- default:0 -->
		<!--property name="testConnectionOnCheckin" value="toBeDefined" / --><!-- default:false -->
		<!--property name="testConnectionOnCheckout" value="toBeDefined" / --><!-- default:false -->
		<!--property name="unreturnedConnectionTimeout" value="toBeDefined" / --><!-- default:0 -->
	</bean>	

	<!-- Set up the mapping jndiName -> Datasource -->
	<bean id="jndiEnvproperties" class="org.springframework.beans.factory.config.MapFactoryBean">
		<property name="targetMapClass" value="java.util.LinkedHashMap" />
		<property name="sourceMap">
			<map>
				<entry key="java:comp/env/bonitaDS" value-ref="bonitaDataSource" />
				<entry key="java:comp/env/bonitaSequenceManagerDS" value-ref="bonitaSequenceManagerDataSource" />
			</map>
		</property>
	</bean>

	<!-- This is the base class that will allow to lookup the JNDI tree -->
	<bean id="jndiTemplate" class="org.springframework.jndi.JndiTemplate">
	</bean>

	<!-- Bind the mapping into Carol -->
	<bean id="carolJNDI" class="org.bonitasoft.engine.local.CarolJNDISetup"
		scope="singleton" init-method="init" destroy-method="clean">
		<constructor-arg name="jndiTemplate" ref="jndiTemplate" />
		<constructor-arg name="jndiMapping" ref="jndiEnvproperties" />
		<constructor-arg name="carolProperties" value="carol-perf.properties" />
	</bean>

</beans>
